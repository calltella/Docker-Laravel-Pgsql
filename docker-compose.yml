version: '3.6'
services:
    laravel:
        container_name: 'docker_php_1' # cron起動しなくなるので名前変えない
        build:
            context: .
            dockerfile: ./infra/php/Dockerfile
        environment:
            TZ: 'Asia/Tokyo'
            WEBROOT: '/var/www/html/public'
            PHP_REDIS_SESSION_HOST: 'redis'
            COMPOSERMIRROR: 'https://packagist.org'
            NPMMIRROR: 'https://registry.npm.taobao.org'
        ports:
            - '${APP_PORT:-80}:80'
        volumes:
            - ./export:/tmp
            - './laravel:/var/www/html'
            - './infra/nginx/logs:/var/log/nginx'
        depends_on:
            - postgres
        restart: '${DOCKER_RESTART}'
    postgres:
        container_name: postgres
        image: groonga/pgroonga:2.4.4-alpine-14
        ports:
            - 5432:5432
        volumes:
            - postgres_volume:/var/lib/postgresql/data
            - ./export:/tmp
        environment:
            TZ: "Asia/Tokyo"
            POSTGRES_PASSWORD: root
            POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
        restart: '${DOCKER_RESTART}'
    pgadmin4:
        container_name: pgadmin4
        image: dpage/pgadmin4:latest
        ports:
            - 8080:80
        volumes:
            - pgadmin4_volume:/var/lib/pgadmin
            - ./export/pgadmin4:/tmp/pgadmin4
        environment:
            PGADMIN_DEFAULT_EMAIL: '${PGADMIN_DEFAULT_EMAIL}'
            PGADMIN_DEFAULT_PASSWORD: root
        hostname: pgadmin4
        deploy:
          replicas: '${PGADMIN4_CONTINER_START}'
        depends_on:
          - postgres
    cron:
        container_name: 'docker_cron_1'
        build: ./infra/cron
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        restart: '${DOCKER_RESTART}'
    phpipam-web:
        image: phpipam/phpipam-www:1.5x
        ports:
            - "8000:80"
        environment:
            - TZ=Asia/Tokyo
            - IPAM_DATABASE_HOST=phpipam-mariadb
            - IPAM_DATABASE_PASS=phpipam
            - IPAM_DATABASE_WEBHOST=%
        restart: '${DOCKER_RESTART}'
        volumes:
            - phpipam-logo:/phpipam/css/images/logo
        depends_on:
            - phpipam-mariadb

    phpipam-cron:
        image: phpipam/phpipam-cron:1.5x
        environment:
            - TZ=Asia/Tokyo
            - IPAM_DATABASE_HOST=phpipam-mariadb
            - IPAM_DATABASE_PASS=phpipam
            - SCAN_INTERVAL=1h
        restart: '${DOCKER_RESTART}'
        depends_on:
            - phpipam-mariadb

    phpipam-mariadb:
        image: mariadb:10.6
        environment:
            - MYSQL_ROOT_PASSWORD=pwd
            - MYSQL_DATABASE=test
            - MYSQL_USER=user
            - MYSQL_PASSWORD=pwd
        restart: '${DOCKER_RESTART}'
        deploy:
            resources:
                limits:
                    memory: 512M   # メモリの制限を設定
                reservations:
                    memory: 256M   # メモリの予約を設定
        volumes:
            - phpipam-db-data:/var/lib/mysql
    phpipam-phpmyadmin:
        image: phpmyadmin/phpmyadmin
        depends_on:
            - phpipam-mariadb
        environment:
            - PMA_ARBITRARY=1
            - PMA_HOSTS=phpipam-mariadb
            - PMA_USER=root
            - PMA_PASSWORD=pwd
        ports:
            - "3000:80"
        deploy:
            replicas: '${PHPMYADMIN_CONTINER_START}'
        volumes:
            - ./docker/phpmyadmin/sessions:/sessions
networks:
    default:
        driver: bridge
        ipam:
            driver: default
            config:
                - subnet: 192.168.10.0/27
                # - subnet: 192.168.10.32/27
                # - subnet: 192.168.10.64/27
                # - subnet: 192.168.10.96/27

volumes:
    postgres_volume:
    pgadmin4_volume:
    phpipam-db-data:
    phpipam-logo:

